(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=n(a);fetch(a.href,i)}})();let N;const Ne=1800*1e3;let ue=null;function Ge(){N?(localStorage.removeItem("lastPlanId"),localStorage.removeItem("lastViewId"),sessionStorage.removeItem("lastPlanId"),sessionStorage.removeItem("lastViewId"),localStorage.removeItem("lastActivity"),N.signOut()):console.error("Auth module not initialized. Cannot sign out.")}function Qe(e=!1){console.log("Logout event triggered..."),document.dispatchEvent(new CustomEvent("logout-request",{detail:{isTimeout:e}}))}async function Le(e){clearTimeout(ue),localStorage.setItem("lastActivity",new Date().getTime()),ue=setTimeout(async()=>{e.currentUser&&(console.log("Session timeout, saving data before logging out."),e.forceSave&&await e.forceSave(),Qe(!0))},Ne)}function We(e){const t=()=>Le(e);window.addEventListener("mousemove",t),window.addEventListener("mousedown",t),window.addEventListener("keypress",t),window.addEventListener("touchmove",t),window.addEventListener("scroll",t,!0),Le(e)}function Ke(){clearTimeout(ue)}function je(e){N=e;const t=document.getElementById("login-btn");if(!t)return;const n=document.getElementById("email"),s=document.getElementById("password"),a=document.getElementById("auth-error"),i=document.getElementById("forgot-password-btn"),r=document.getElementById("reset-view"),c=document.getElementById("login-view"),d=document.getElementById("register-view"),l=document.getElementById("show-register-view-btn"),m=document.getElementById("back-to-login-from-register-btn"),p=document.getElementById("register-email"),u=document.getElementById("register-password"),b=document.getElementById("terms-agree"),f=document.getElementById("create-account-btn"),h=document.getElementById("register-error"),y=document.getElementById("reset-email"),E=document.getElementById("send-reset-btn"),B=document.getElementById("reset-message-container"),x=document.getElementById("back-to-login-btn"),w=()=>{a.style.display="none",N.signInWithEmailAndPassword(n.value,s.value).catch(L=>{let $="An unexpected error occurred. Please try again.";switch(L.code){case"auth/invalid-login-credentials":case"auth/invalid-credential":case"auth/user-not-found":case"auth/wrong-password":$="Incorrect email or password. Please check your details and try again.";break;case"auth/invalid-email":$="The email address is not valid. Please enter a valid email.";break}a.textContent=$,a.style.display="block"})},C=L=>{L.key==="Enter"&&(L.preventDefault(),w())};t.addEventListener("click",w),n.addEventListener("keyup",C),s.addEventListener("keyup",C),f.addEventListener("click",()=>{const L=p.value,$=u.value;if(h.style.display="none",!b.checked){h.textContent="You must agree to the Terms and Conditions and Privacy Policy.",h.style.display="block";return}N.createUserWithEmailAndPassword(L,$).catch(Y=>{let z="An unexpected error occurred. Please try again.";switch(Y.code){case"auth/email-already-in-use":z="This email may already be registered. Please try logging in instead.";break;case"auth/weak-password":z="The password is too weak. Please choose a stronger password.";break;case"auth/invalid-email":z="The email address is not valid. Please enter a valid email.";break}h.textContent=z,h.style.display="block"})}),l.addEventListener("click",L=>{L.preventDefault(),c.classList.add("hidden"),r.classList.add("hidden"),d.classList.remove("hidden"),a.style.display="none"}),m.addEventListener("click",L=>{L.preventDefault(),d.classList.add("hidden"),c.classList.remove("hidden")}),i.addEventListener("click",L=>{L.preventDefault(),c.classList.add("hidden"),d.classList.add("hidden"),r.classList.remove("hidden"),a.style.display="none",B.innerHTML=""}),x.addEventListener("click",L=>{L.preventDefault(),r.classList.add("hidden"),c.classList.remove("hidden")}),E.addEventListener("click",()=>{const L=y.value;if(B.innerHTML="",!L){B.innerHTML='<p class="auth-error" style="display:block; margin-bottom: 1rem;">Please enter your email address.</p>';return}E.disabled=!0,E.textContent="Sending...",N.sendPasswordResetEmail(L).then(()=>{B.innerHTML='<p class="auth-success">If an account exists for this email, a password reset link has been sent. Please check your inbox.</p>'}).catch($=>{$.code==="auth/invalid-email"?B.innerHTML='<p class="auth-error" style="display:block; margin-bottom: 1rem;">The email address is not valid. Please enter a valid email.</p>':B.innerHTML='<p class="auth-success">If an account exists for this email, a password reset link has been sent. Please check your inbox.</p>',console.error("Password Reset Error:",$.code,$.message)}).finally(()=>{setTimeout(()=>{E.disabled=!1,E.textContent="Send Reset Link"},3e3)})})}async function Ye(){const e=await fetch("/.netlify/functions/config");if(!e.ok)throw new Error("Could not fetch Firebase configuration.");return e.json()}async function ze(e,t){const n=await fetch("/.netlify/functions/generate-plan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planSummary:e}),signal:t});if(!n.ok){let a;try{a=await n.json()}catch{throw new Error(n.statusText||"The AI assistant failed to respond.")}throw new Error(a.error||"The AI assistant failed to generate a response.")}return(await n.json()).actionPlan.replace(/^```(html)?\s*/,"").replace(/```$/,"").trim()}async function Xe(e,t,n,s){const a=await fetch("/.netlify/functions/generate-chat-response",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planSummary:e,chatHistory:t,userMessage:n,calendarData:s})});if(!a.ok){let r;try{r=await a.json()}catch{throw new Error(a.statusText||"The AI assistant failed to respond.")}throw new Error(r.error||"The AI assistant failed to generate a response.")}return(await a.json()).response}let se,I,Pe,D,ae=null;function Be(e){if(!e||e.trim()==="")return null;const t=/^\s*(\d{1,2})[\s\/-](\d{1,2}|[a-zA-Z]{3})[\s\/-](\d{2}|\d{4})\s*$/,n=e.trim().match(t);if(!n)return null;let[,s,a,i]=n;if(s=parseInt(s,10),i=parseInt(i,10),i<100&&(i+=2e3),isNaN(a)){if(a={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11}[a.toLowerCase()],a===void 0)return null}else a=parseInt(a,10)-1;const r=new Date(Date.UTC(i,a,s));return r.getUTCFullYear()===i&&r.getUTCMonth()===a&&r.getUTCDate()===s?r:null}async function De(e,t){if(!t.currentUser)return;const n=e.collection("users").doc(t.currentUser.uid).collection("calendar").doc("user_calendar");try{const s=await n.get();if(s.exists)t.calendar.data=s.data();else{const a=await n.get();t.calendar.data=a.exists?a.data():{}}}catch(s){console.error("Error loading calendar data:",s),t.calendar.data={}}}function G(){const e=document.getElementById("calendar-grid");if(!e)return;e.innerHTML="";const t=I.calendar.currentDate,n=new Date;n.setHours(0,0,0,0);const s=t.getMonth(),a=t.getFullYear();document.getElementById("calendar-month-year").textContent=t.toLocaleString("en-GB",{month:"long",year:"numeric"});const i=new Date(a,s,1),r=new Date(a,s+1,0).getDate(),c=(i.getDay()+6)%7;["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].forEach(d=>{const l=document.createElement("div");l.classList.add("calendar-day-header"),l.textContent=d,e.appendChild(l)});for(let d=0;d<c;d++)e.appendChild(document.createElement("div"));for(let d=1;d<=r;d++){const l=document.createElement("div");l.classList.add("calendar-day"),l.style.position="relative";const m=new Date(a,s,d),p=`${a}-${String(s+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;l.dataset.dateKey=p,m.getTime()===n.getTime()&&l.classList.add("current-day"),p===D&&l.classList.add("selected");const u=document.createElement("div");u.classList.add("calendar-day-number"),u.textContent=d,l.appendChild(u);const b=I.calendar.data[p]||[];if(Array.isArray(b)&&b.length>0){if(b.length>=8?l.classList.add("day-density-4"):b.length>=6?l.classList.add("day-density-3"):b.length>=4?l.classList.add("day-density-2"):b.length>=1&&l.classList.add("day-density-1"),b.some(y=>y.type==="birthday")){const y=document.createElement("div");y.className="birthday-indicator",y.innerHTML='<i class="bi bi-cake2"></i>',l.appendChild(y)}const h=b.filter(y=>y.type!=="birthday");if(h.length>0){const y=document.createElement("div");y.classList.add("event-dots-container"),h.forEach(E=>{const B=document.createElement("div");B.className=`event-dot ${E.type}`,y.appendChild(B)}),l.appendChild(y)}}e.appendChild(l)}}function Z(e){D=e,document.getElementById("add-event-btn").classList.remove("hidden"),document.querySelectorAll(".calendar-day.selected").forEach(l=>l.classList.remove("selected"));const t=document.querySelector(`.calendar-day[data-date-key="${e}"]`);t&&t.classList.add("selected");const[n,s,a]=e.split("-").map(Number),r=new Date(n,s-1,a).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"long"});document.getElementById("day-detail-title").textContent=r,document.getElementById("add-event-form").classList.add("hidden");const c=document.getElementById("day-event-list");c.classList.remove("hidden"),c.innerHTML="";const d=I.calendar.data[e]||[];d.length>0?(d.sort((l,m)=>l.allDay&&!m.allDay?-1:!l.allDay&&m.allDay?1:(l.timeFrom||"").localeCompare(m.timeFrom||"")),d.forEach((l,m)=>{const p=document.createElement("div");p.classList.add("event-item"),p.dataset.index=m;let u="";if(l.allDay)u='<p class="event-item-time font-semibold">All Day</p>';else if(l.timeFrom){let f=l.timeFrom;l.timeTo&&(f+=` - ${l.timeTo}`),u=`<p class="event-item-time">${f}</p>`}const b=l.description?`<p class="event-item-description">${l.description.replace(/\n/g,"<br>")}</p>`:"";p.innerHTML=`
                <div class="event-item-header">
                    <div>
                        <h5 class="event-item-title">${l.title}</h5>
                        ${u}
                    </div>
                    <div class="flex items-center gap-2">
                         <span class="event-type-badge ${l.type}">${l.type}</span>
                         <button class="btn-remove-row btn-remove-event" data-index="${m}" title="Delete event"><i class="bi bi-x-lg"></i></button>
                    </div>
                </div>
                ${b}`,c.appendChild(p)})):c.innerHTML='<p class="text-gray-500 text-center py-4">No events scheduled for this day.</p>',document.getElementById("add-event-form").classList.add("hidden")}function Je(e){I.calendar.editingEventIndex=e;const t=I.calendar.data[D][e],n=document.getElementById("add-event-form-title");n.textContent="Edit Event",document.getElementById("add-event-btn").classList.add("hidden"),document.getElementById("day-event-list").classList.add("hidden"),document.getElementById("add-event-form").classList.remove("hidden"),document.getElementById("event-title-input").value=t.title;const s=document.getElementById("event-all-day-toggle");s.checked=t.allDay||!1,document.getElementById("event-time-inputs-container").classList.toggle("hidden",s.checked),document.getElementById("event-time-from-input").value=t.timeFrom||"",document.getElementById("event-time-to-input").value=t.timeTo||"",document.getElementById("event-description-input").value=t.description||"";const a=document.getElementById("category-search-input"),i=document.getElementById("event-type-input"),r=document.getElementById("category-selected-icon-container"),c=document.querySelector("#category-dropdown .dropdown-options");if(r.innerHTML='<span id="category-selected-dot" class="selected-dot"></span>',r.className="selected-icon-container",t.type){const d=c.querySelector(`.dropdown-option[data-type="${t.type}"]`);if(d){const l=d.querySelector(".option-icon, .option-dot");r.innerHTML=l.outerHTML,r.classList.add(t.type),r.classList.toggle("has-icon",l.classList.contains("option-icon")),a.value=d.textContent.trim(),i.value=t.type}else a.value="",i.value=""}else a.value="",i.value=""}async function Ze(){if(!ae)return;const{dateKey:e,index:t}=ae,n=I.calendar.data[e]||[];n.splice(t,1);const s=se.collection("users").doc(I.currentUser.uid).collection("calendar").doc("user_calendar"),a={};a[e]=n.length>0?n:firebase.firestore.FieldValue.delete();try{await s.set(a,{merge:!0}),n.length>0?I.calendar.data[e]=n:delete I.calendar.data[e],G(),Z(e)}catch(i){console.error("Error removing event:",i),alert("Could not remove the event. Please try again.")}finally{ae=null}}function et(){const e=document.getElementById("calendar-modal"),t=document.getElementById("calendar-close-btn"),n=document.getElementById("calendar-prev-month-btn"),s=document.getElementById("calendar-next-month-btn"),a=document.getElementById("calendar-today-btn"),i=document.getElementById("calendar-grid"),r=document.getElementById("add-event-btn"),c=document.getElementById("cancel-event-btn"),d=document.getElementById("save-event-btn"),l=document.getElementById("event-all-day-toggle"),m=document.getElementById("event-time-inputs-container"),p=document.getElementById("day-event-list"),u=document.getElementById("category-dropdown"),b=document.getElementById("category-search-input");if(!e||!l||!u){console.warn("Calendar UI elements not found. Skipping event listener setup.");return}if(l.addEventListener("change",()=>{m&&m.classList.toggle("hidden",l.checked)}),u&&b){const f=u.querySelector(".dropdown-selected"),h=u.querySelector(".dropdown-options"),y=document.getElementById("event-type-input"),E=()=>{const x=h.querySelector(".is-highlighted");x&&x.classList.remove("is-highlighted");const w=b.value.toLowerCase(),C=h.querySelectorAll(".dropdown-option:not(.no-results)");let L=0;C.forEach(Y=>{Y.textContent.trim().toLowerCase().includes(w)?(Y.style.display="flex",L++):Y.style.display="none"});let $=h.querySelector(".no-results");L===0?($||($=document.createElement("div"),$.className="dropdown-option no-results",$.textContent="No results found",h.appendChild($)),$.style.display="flex"):$&&($.style.display="none")},B=x=>{const w=x.dataset.type,C=document.getElementById("category-selected-icon-container"),L=x.querySelector(".option-icon, .option-dot");C.innerHTML=L.outerHTML,C.className=`selected-icon-container ${w}`,C.classList.toggle("has-icon",L.classList.contains("option-icon")),b.value=x.textContent.trim(),y.value=w,u.classList.remove("open")};b.addEventListener("focus",()=>{u.classList.add("open"),b.select(),E()}),b.addEventListener("input",E),b.addEventListener("keydown",x=>{if(!u.classList.contains("open")){(x.key==="ArrowDown"||x.key==="ArrowUp")&&u.classList.add("open");return}const w=Array.from(h.querySelectorAll(".dropdown-option:not(.no-results)")).filter(L=>L.style.display!=="none");if(w.length===0)return;let C=w.findIndex(L=>L.classList.contains("is-highlighted"));switch(x.key){case"ArrowDown":x.preventDefault(),C>=0&&w[C].classList.remove("is-highlighted");const L=(C+1)%w.length;w[L].classList.add("is-highlighted"),w[L].scrollIntoView({block:"nearest"});break;case"ArrowUp":x.preventDefault(),C>=0&&w[C].classList.remove("is-highlighted");const $=(C-1+w.length)%w.length;w[$].classList.add("is-highlighted"),w[$].scrollIntoView({block:"nearest"});break;case"Enter":x.preventDefault(),C>=0&&B(w[C]);break;case"Escape":u.classList.remove("open");break}}),f.addEventListener("click",x=>{x.target!==b&&b.focus()}),document.addEventListener("click",x=>{if(!u.contains(x.target)){u.classList.remove("open");const w=b.value,C=y.value;if(C&&w.toLowerCase()!==C.toLowerCase()){const L=h.querySelector(`.dropdown-option[data-type="${C}"]`);L&&(b.value=L.textContent.trim())}else C||(b.value="")}}),h.addEventListener("click",x=>{const w=x.target.closest(".dropdown-option:not(.no-results)");w&&B(w)})}t&&t.addEventListener("click",()=>e.classList.add("hidden")),n&&n.addEventListener("click",()=>{I.calendar.currentDate.setDate(1),I.calendar.currentDate.setMonth(I.calendar.currentDate.getMonth()-1),G()}),s&&s.addEventListener("click",()=>{I.calendar.currentDate.setDate(1),I.calendar.currentDate.setMonth(I.calendar.currentDate.getMonth()+1),G()}),a&&a.addEventListener("click",()=>{const f=new Date;I.calendar.currentDate=f;const h=`${f.getFullYear()}-${String(f.getMonth()+1).padStart(2,"0")}-${String(f.getDate()).padStart(2,"0")}`;G(),Z(h)}),i&&i.addEventListener("click",f=>{const h=f.target.closest(".calendar-day");h&&h.dataset.dateKey&&Z(h.dataset.dateKey)}),p&&p.addEventListener("click",async f=>{const h=f.target.closest(".btn-remove-event"),y=f.target.closest(".event-item");if(h){f.stopPropagation();const E=parseInt(h.dataset.index,10),B=y.querySelector(".event-item-title").textContent;ae={dateKey:D,index:E},Pe("confirmDeleteEvent",{eventTitle:B})}else if(y){const E=parseInt(y.dataset.index,10);Je(E)}}),r&&r.addEventListener("click",()=>{I.calendar.editingEventIndex=null,p&&p.classList.add("hidden"),document.getElementById("add-event-form").classList.remove("hidden");const f=document.getElementById("add-event-form-title");if(f.textContent="Add New Event",r.classList.add("hidden"),document.getElementById("event-title-input").value="",document.getElementById("event-all-day-toggle").checked=!1,document.getElementById("event-time-inputs-container").classList.remove("hidden"),document.getElementById("event-time-from-input").value="",document.getElementById("event-time-to-input").value="",document.getElementById("event-description-input").value="",u){const h=document.getElementById("category-selected-icon-container");h.innerHTML='<span id="category-selected-dot" class="selected-dot"></span>',h.className="selected-icon-container",document.getElementById("category-search-input").value="",document.getElementById("event-type-input").value=""}}),c&&c.addEventListener("click",()=>{I.calendar.editingEventIndex=null,document.getElementById("add-event-form").classList.add("hidden"),p&&p.classList.remove("hidden"),document.getElementById("add-event-btn").classList.remove("hidden")}),d&&d.addEventListener("click",async()=>{const f=document.getElementById("event-title-input").value.trim(),h=document.getElementById("event-type-input").value;if(!f||!h){alert("Please provide a title and select an event type.");return}const y=l.checked,E={title:f,allDay:y,timeFrom:y?"":document.getElementById("event-time-from-input").value,timeTo:y?"":document.getElementById("event-time-to-input").value,type:h,description:document.getElementById("event-description-input").value.trim()},B=I.calendar.data[D]||[];I.calendar.editingEventIndex!==null?B[I.calendar.editingEventIndex]=E:B.push(E);const x=se.collection("users").doc(I.currentUser.uid).collection("calendar").doc("user_calendar"),w={};w[D]=B;try{await x.set(w,{merge:!0}),I.calendar.data[D]=B,I.calendar.editingEventIndex=null,G(),Z(D)}catch(C){console.error("Error saving event:",C),alert("Could not save the event. Please try again.")}})}function tt(e,t,n){se=e,I=t,Pe=n;const s=document.getElementById("radial-action-calendar");s&&s.addEventListener("click",()=>{I.calendar.currentDate=new Date;const a=new Date;D=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`,De(se,I).then(()=>{G(),Z(D),document.getElementById("calendar-modal").classList.remove("hidden"),document.getElementById("radial-menu-container").classList.remove("open")})}),document.addEventListener("event-deletion-confirmed",Ze),et()}const nt={vision:{requiredFields:["managerName","bakeryLocation","quarter","quarterlyTheme","month1Goal","month2Goal","month3Goal"]}};function U(e){if(!e)return!0;const t=document.createElement("div");return t.innerHTML=e,t.innerText.trim()===""}function Me(e){const t=nt.vision.requiredFields,n=t.length;return{completed:t.filter(a=>!U(e[a])).length,total:n}}function at(e,t,n){const s=n[`m${e}s5_w${t}_status`],a=n[`m${e}s5_w${t}_win`],i=n[`m${e}s5_w${t}_spotlight`],r=n[`m${e}s5_w${t}_shine`];return!!s&&!U(a)&&!U(i)&&!U(r)}function _e(e,t){const n=[`m${e}s1_battle`,`m${e}s1_pillar`,`m${e}s2_levers`,`m${e}s2_powerup_q`,`m${e}s2_powerup_a`,`m${e}s3_people`,`m${e}s4_people`,`m${e}s4_product`,`m${e}s4_customer`,`m${e}s4_place`,`m${e}s6_win`,`m${e}s6_challenge`,`m${e}s6_next`];for(let i=1;i<=4;i++)n.push(`m${e}s5_w${i}_status`,`m${e}s5_w${i}_win`,`m${e}s5_w${i}_spotlight`,`m${e}s5_w${i}_shine`);e==3&&n.push("m3s7_achievements","m3s7_challenges","m3s7_narrative","m3s7_next_quarter");const s=n.length;return{completed:n.filter(i=>!U(t[i])).length,total:s}}function He(e){let t=0,n=0;const s=Me(e);t+=s.total,n+=s.completed;for(let a=1;a<=3;a++){const i=_e(a,e);t+=i.total,n+=i.completed}return t>0?Math.round(n/t*100):0}let qe,pe,ee,Ie;function st(e){if(!e||!e.toDate)return"N/A";const t=new Date,n=e.toDate(),s=new Date(t.getFullYear(),t.getMonth(),t.getDate()),a=new Date(t.getFullYear(),t.getMonth(),t.getDate()-1);if(n>=s)return`Today at ${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`;if(n>=a)return`Yesterday at ${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`;{const i=n.getDate(),r=n.toLocaleString("en-GB",{month:"short"}),c=n.getFullYear();return`${i} ${r} ${c}`}}async function oe(){if(!pe.currentUser)return;const e=document.getElementById("dashboard-content"),t=document.getElementById("dashboard-view");if(!t||!e)return;t.classList.remove("hidden");let n=[];try{n=(await qe.collection("users").doc(pe.currentUser.uid).collection("plans").orderBy("lastEdited","desc").get()).docs.map(r=>({id:r.id,...r.data()}))}catch(a){console.error("Error fetching user plans:",a)}let s='<div class="flex justify-between items-center"><h1 class="text-4xl font-black text-gray-900 font-poppins">Your Growth Plans</h1></div><div class="dashboard-grid">';n.forEach(a=>{const i=He(a),r=st(a.lastEdited),c=a.planName||"Untitled Plan";s+=`
            <div class="plan-card">
                <div class="plan-card-actions">
                    <button class="plan-action-btn edit-plan-btn" data-plan-id="${a.id}" data-plan-name="${c}" data-plan-quarter="${a.quarter||""}" title="Edit Details"><i class="bi bi-pencil-square"></i></button>
                    <button class="plan-action-btn delete-plan-btn" data-plan-id="${a.id}" data-plan-name="${c}" title="Delete Plan"><i class="bi bi-trash3-fill"></i></button>
                </div>
                <div class="plan-card-main" data-plan-id="${a.id}">
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold font-poppins">${c}</h3>
                        <p class="text-sm text-gray-500 mt-1">${a.quarter||"No quarter set"}</p>
                    </div>
                    <div class="mt-6 pt-4 border-t text-sm space-y-2">
                        <div class="flex justify-between"><span class="font-semibold text-gray-600">Last Edited:</span><span>${r}</span></div>
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-600">Completion:</span>
                            <div class="progress-circle" style="--progress: ${i}">
                                <div class="progress-circle-inner">${i}%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`}),s+='<div class="plan-card new-plan-card" id="create-new-plan-btn"><i class="bi bi-plus-circle-dotted text-4xl"></i><p class="mt-2 font-semibold">Create New Plan</p></div></div>',e.innerHTML=s}function it(e,t,n,s){qe=e,pe=t,ee=n,Ie=s;const a=document.getElementById("dashboard-content");if(!a)return;const i=document.getElementById("dashboard-logout-btn"),r=document.getElementById("dashboard-profile-btn"),c=document.getElementById("dashboard-team-btn");i.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("logout-request"))}),r.addEventListener("click",()=>{window.location.href="/profile.html"}),c&&c.addEventListener("click",()=>{window.location.href="/team.html"}),a.addEventListener("click",d=>{const l=d.target.closest("#create-new-plan-btn"),m=d.target.closest(".plan-card-main"),p=d.target.closest(".edit-plan-btn"),u=d.target.closest(".delete-plan-btn");p?(d.stopPropagation(),ee("edit",{planId:p.dataset.planId,currentName:p.dataset.planName,currentQuarter:p.dataset.planQuarter})):u?(d.stopPropagation(),ee("delete",{planId:u.dataset.planId,planName:u.dataset.planName})):l?ee("create"):m&&Ie(m.dataset.planId)})}let X,S,R=null,A=[],O=[];const o={modalOverlay:document.getElementById("modal-overlay"),modalBox:document.getElementById("modal-box"),modalTitle:document.getElementById("modal-title"),modalContent:document.getElementById("modal-content"),modalActionBtn:document.getElementById("modal-action-btn"),modalCancelBtn:document.getElementById("modal-cancel-btn"),modalCloseBtn:document.getElementById("modal-close-btn"),appView:document.getElementById("app-view"),mobileMenuBtn:document.getElementById("mobile-menu-btn"),sidebarOverlay:document.getElementById("sidebar-overlay"),sidebar:document.getElementById("sidebar"),mainContent:document.querySelector("#app-view main"),radialMenuContainer:document.getElementById("radial-menu-container"),radialMenuFab:document.getElementById("radial-menu-fab"),radialMenuOverlay:document.getElementById("radial-menu-overlay"),saveIndicator:document.getElementById("save-indicator"),creationLoadingView:document.getElementById("creation-loading-view"),cookieBanner:document.getElementById("cookie-consent-banner"),acceptBtn:document.getElementById("cookie-accept-btn"),declineBtn:document.getElementById("cookie-decline-btn")};function ot(e){!e||!e.isContentEditable||(e.innerText.trim()===""?e.classList.add("is-placeholder-showing"):e.classList.remove("is-placeholder-showing"))}function j(){const e=document.getElementById("undo-btn"),t=document.getElementById("redo-btn");e&&(e.disabled=A.length<=1),t&&(t.disabled=O.length===0)}function J(){const e=document.getElementById("ai-printable-area");e&&(A.push(e.innerHTML),O=[],j())}function lt(){if(A.length>1){const e=A.pop();O.push(e);const t=A[A.length-1];document.getElementById("ai-printable-area").innerHTML=t,j()}}function rt(){if(O.length>0){const e=O.pop();A.push(e),document.getElementById("ai-printable-area").innerHTML=e,j()}}function ge(e){if(!e)return;(a=>{a.querySelectorAll("table").forEach(r=>{const c=r.querySelectorAll("thead th"),d={"Action Step":{index:0,type:"text"},Pillar:{index:1,type:"text"},Owner:{index:2,type:"text"},"Due Date":{index:3,type:"date"},Status:{index:5,type:"text"}};c.forEach(l=>{const m=l.innerText.trim();if(d[m]){const p=d[m];l.classList.add("sortable-header"),l.dataset.column=p.index,l.dataset.sortType=p.type,l.innerHTML="";const u=document.createElement("div");u.className="header-flex-wrapper";const b=document.createElement("span");b.textContent=m;const f=document.createElement("span");f.className="sort-icon",u.appendChild(b),u.appendChild(f),l.appendChild(u)}})})})(e);const n=a=>{const i=a.closest("table"),r=i.querySelector("tbody"),c=parseInt(a.dataset.column,10),d=a.dataset.sortType||"text",m=(a.dataset.sortDir||"desc")==="asc"?"desc":"asc";i.querySelectorAll(".sortable-header").forEach(u=>{u.removeAttribute("data-sort-dir")}),a.dataset.sortDir=m;const p=Array.from(r.querySelectorAll("tr"));p.sort((u,b)=>{const f=u.querySelectorAll("td")[c],h=b.querySelectorAll("td")[c],y=f?f.innerText.trim():"",E=h?h.innerText.trim():"";let B=0;if(d==="date"){const x=Be(y),w=Be(E);x&&w?B=x.getTime()-w.getTime():x&&!w?B=-1:!x&&w?B=1:B=0}else B=y.localeCompare(E,void 0,{numeric:!0});return m==="asc"?B:-B}),r.innerHTML="",p.forEach(u=>r.appendChild(u)),J()};e.addEventListener("click",a=>{const i=a.target.closest(".btn-add-row"),r=a.target.closest(".btn-remove-row"),c=a.target.closest(".ai-tab-btn"),d=a.target.closest(".sortable-header");if(i){const l=i.closest("table").querySelector("tbody");if(l){const m=document.createElement("tr");m.innerHTML='<td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td class="actions-cell"><button class="btn-remove-row"><i class="bi bi-trash3"></i></button></td>',l.appendChild(m),J()}}if(r&&(r.closest("tr").remove(),J()),c){if(c.classList.contains("active"))return;const l=c.closest(".ai-action-plan-container");l.querySelectorAll(".ai-tab-btn").forEach(p=>p.classList.remove("active")),l.querySelectorAll(".ai-tabs-content > div").forEach(p=>p.classList.remove("active")),c.classList.add("active");const m=l.querySelector(`[data-tab-panel="${c.dataset.tab}"]`);m&&m.classList.add("active")}d&&n(d)}),new MutationObserver(a=>{a.some(i=>i.type==="characterData")&&J()}).observe(e,{childList:!1,subtree:!0,characterData:!0})}async function dt(){const e=document.getElementById("ai-printable-area").innerHTML,t=o.modalActionBtn,n=t.innerHTML;t.disabled=!0,t.innerHTML='<i class="bi bi-check-circle-fill"></i> Saved!',R?await R(!0,{aiActionPlan:e}):console.error("No active save function to save AI plan!"),A=[e],O=[],j(),setTimeout(()=>{t.disabled=!1,t.innerHTML=n},2e3)}function ct(){P("confirmRegenerate")}function fe(){const e=o.modalBox.dataset.type;e==="aiActionPlan_generate"&&S.aiPlanGenerationController&&S.aiPlanGenerationController.abort();const t=e==="aiActionPlan_view",n=A.length>1;t&&n?P("confirmClose"):_()}async function le(){const e=o.modalBox.dataset.type,t=o.modalBox.dataset.planId;if(e==="timeout"){_();return}switch(e){case"create":const n=document.getElementById("newPlanName"),s=n.value.trim(),a=document.getElementById("newPlanQuarter").value.trim(),i=o.modalActionBtn.textContent,r=document.getElementById("modal-error-container");if(r&&(r.innerHTML=""),n.classList.remove("input-error"),!s){n.classList.add("input-error","shake"),setTimeout(()=>n.classList.remove("shake"),500);return}o.modalActionBtn.disabled=!0,o.modalActionBtn.textContent="Checking...";const c=X.collection("users").doc(S.currentUser.uid).collection("plans");if(!(await c.where("planName","==",s).get()).empty){n.classList.add("input-error","shake"),r&&(r.innerHTML='<p class="auth-error" style="display:block; margin: 0; width: 100%;">A plan with this name already exists.</p>'),o.modalActionBtn.disabled=!1,o.modalActionBtn.textContent=i,setTimeout(()=>n.classList.remove("shake"),500);return}o.modalActionBtn.disabled=!1,o.modalActionBtn.textContent=i,_(),o.creationLoadingView.classList.remove("hidden");try{const u=await X.collection("users").doc(S.currentUser.uid).get(),b=u.exists?u.data():{name:"",bakery:""},f=await c.add({planName:s,quarter:a,createdAt:firebase.firestore.FieldValue.serverTimestamp(),lastEdited:firebase.firestore.FieldValue.serverTimestamp(),managerName:b.name,bakeryLocation:b.bakery});document.dispatchEvent(new CustomEvent("plan-selected",{detail:{planId:f.id}}))}catch(p){console.error("Error creating new plan:",p)}finally{o.creationLoadingView.classList.add("hidden")}break;case"edit":const l=document.getElementById("editPlanName").value.trim(),m=document.getElementById("editPlanQuarter").value.trim();if(l)try{await X.collection("users").doc(S.currentUser.uid).collection("plans").doc(t).update({planName:l,quarter:m}),document.dispatchEvent(new CustomEvent("rerender-dashboard"))}catch(p){console.error("Error updating plan name:",p)}_();break;case"delete":try{await X.collection("users").doc(S.currentUser.uid).collection("plans").doc(t).delete(),document.dispatchEvent(new CustomEvent("rerender-dashboard"))}catch(p){console.error("Error deleting plan:",p)}_();break;case"confirmDeleteEvent":document.dispatchEvent(new CustomEvent("event-deletion-confirmed")),_();break;case"confirmDeleteConversation":document.dispatchEvent(new CustomEvent("conversation-deletion-confirmed",{detail:{conversationId:t}})),_();break}}async function mt(e,t){P("sharing");try{let n;const a=await e.collection("sharedPlans").where("originalPlanId","==",t.currentPlanId).get();if(a.empty){await e.collection("users").doc(t.currentUser.uid).collection("plans").doc(t.currentPlanId).update({isShared:!0});const c={originalUserId:t.currentUser.uid,originalPlanId:t.currentPlanId,sharedAt:firebase.firestore.FieldValue.serverTimestamp()},d=await e.collection("sharedPlans").add(c);n=`${window.location.origin}/view.html?id=${d.id}`}else{const r=a.docs[0];n=`${window.location.origin}/view.html?id=${r.id}`}const i=document.getElementById("modal-content");i.innerHTML=`<p class="text-sm text-gray-600 mb-4">This link reflects the live plan and updates automatically.</p>
                                  <label for="shareable-link" class="font-semibold block mb-2">Shareable Link:</label>
                                  <div class="flex items-center gap-2">
                                      <input type="text" id="shareable-link" class="form-input" value="${n}" readonly>
                                      <button id="copy-link-btn" class="btn btn-secondary"><i class="bi bi-clipboard"></i></button>
                                  </div>
                                  <p id="copy-success-msg" class="text-green-600 text-sm mt-2 hidden">Link copied!</p>`,document.getElementById("copy-link-btn").addEventListener("click",()=>{document.getElementById("shareable-link").select(),document.execCommand("copy"),document.getElementById("copy-success-msg").classList.remove("hidden"),setTimeout(()=>document.getElementById("copy-success-msg").classList.add("hidden"),2e3)}),o.modalActionBtn.style.display="none",o.modalCancelBtn.textContent="Done"}catch(n){console.error("Error creating shareable link:",n),document.getElementById("modal-content").innerHTML='<p class="text-red-600">Could not create a shareable link. Please try again.</p>'}}async function ye(e,t,n){R=t;const s=e.planData.aiActionPlan;if(s){P("aiActionPlan_view");const a=document.getElementById("modal-content");a.innerHTML=`<div id="ai-printable-area" class="editable-action-plan">${s}</div>`,A=[],O=[],J(),ge(a.querySelector("#ai-printable-area"))}else{e.aiPlanGenerationController&&e.aiPlanGenerationController.abort(),P("aiActionPlan_generate");try{e.aiPlanGenerationController=new AbortController;const a=await ze(n,e.aiPlanGenerationController.signal);e.planData.aiActionPlan=a,await R(!0,{aiActionPlan:a}),ye(e,t,n)}catch(a){if(a.name==="AbortError"){console.log("AI plan generation cancelled.");return}console.error("Error generating AI plan:",a),document.getElementById("modal-content").innerHTML=`<p class="text-red-600 font-semibold">An error occurred.</p><p class="text-gray-600 mt-2 text-sm">${a.message}</p>`,o.modalActionBtn.style.display="none",o.modalCancelBtn.textContent="Close"}finally{e.aiPlanGenerationController=null}}}function ut(){document.querySelectorAll("div[data-maxlength]").forEach(e=>{if(e.parentNode.classList.contains("textarea-wrapper"))return;const t=document.createElement("div");t.className="textarea-wrapper",e.parentNode.insertBefore(t,e),t.appendChild(e);const n=document.createElement("div");n.className="char-counter",t.appendChild(n);const s=()=>{const a=parseInt(e.dataset.maxlength,10),i=e.innerText.length,r=a-i;n.textContent=`${r}`,n.style.color=r<0?"var(--gails-red)":r<20?"#D97706":"var(--gails-text-secondary)"};s(),e.addEventListener("input",s),e.addEventListener("focus",()=>n.classList.add("visible")),e.addEventListener("blur",()=>n.classList.remove("visible")),e.addEventListener("input",()=>ot(e))})}function P(e,t,n){const{planId:s,currentName:a,planName:i,eventTitle:r,currentQuarter:c}=typeof n=="object"?n:{};o.modalBox.classList.remove("file-viewer-modal"),o.modalBox.dataset.type=e,o.modalBox.dataset.planId=s;const d=o.modalActionBtn.parentNode;switch(d.querySelectorAll(".dynamic-btn").forEach(l=>l.remove()),o.modalActionBtn.style.display="inline-flex",o.modalCancelBtn.style.display="inline-flex",o.modalActionBtn.className="btn btn-primary",o.modalCancelBtn.className="btn btn-secondary",o.modalActionBtn.textContent="Action",o.modalCancelBtn.textContent="Cancel",o.modalActionBtn.disabled=!1,o.modalCancelBtn.disabled=!1,o.modalActionBtn.onclick=le,o.modalCancelBtn.onclick=fe,d.style.justifyContent="flex-end",e){case"fileView":o.modalBox.classList.add("file-viewer-modal"),o.modalTitle.textContent=t,o.modalContent.innerHTML=n,o.modalActionBtn.style.display="none",o.modalCancelBtn.textContent="Close";break;case"loading":o.modalTitle.textContent=t,o.modalContent.innerHTML='<div class="flex items-center justify-center p-8"><div class="loading-spinner"></div></div>',o.modalActionBtn.style.display="none",o.modalCancelBtn.style.display="none";break;case"error":o.modalTitle.textContent=t,o.modalContent.innerHTML=`<p class="text-red-600">${n}</p>`,o.modalActionBtn.style.display="none",o.modalCancelBtn.textContent="Close";break;case"create":o.modalTitle.textContent="Create New Plan",o.modalContent.innerHTML=`<label for="newPlanName" class="font-semibold block mb-2">Plan Name:</label>
                                                  <input type="text" id="newPlanName" class="form-input" placeholder="e.g., Q4 2025 Focus" value="New Plan ${new Date().toLocaleDateString("en-GB")}">
                                                  <label for="newPlanQuarter" class="font-semibold block mb-2 mt-4">Quarter:</label>
                                                  <input type="text" id="newPlanQuarter" class="form-input" placeholder="e.g., Q3 FY26">
                                                  <div id="modal-error-container" class="modal-error-container"></div>`,o.modalActionBtn.textContent="Create Plan",document.getElementById("newPlanName").addEventListener("keyup",u=>{u.key==="Enter"&&le()});break;case"edit":o.modalTitle.textContent="Edit Plan Details",o.modalContent.innerHTML=`<label for="editPlanName" class="font-semibold block mb-2">Plan Name:</label>
                                                  <input type="text" id="editPlanName" class="form-input" value="${a}">
                                                  <label for="editPlanQuarter" class="font-semibold block mb-2 mt-4">Quarter:</label>
                                                  <input type="text" id="editPlanQuarter" class="form-input" placeholder="e.g., Q3 FY26" value="${c||""}">`,o.modalActionBtn.textContent="Save Changes",document.getElementById("editPlanName").addEventListener("keyup",u=>{u.key==="Enter"&&le()});break;case"delete":o.modalTitle.textContent="Confirm Deletion",o.modalContent.innerHTML=`<p>Are you sure you want to permanently delete the plan: <strong class="font-bold">${i}</strong>?</p><p class="mt-2 text-sm text-red-700 bg-red-100 p-3 rounded-lg">This action is final and cannot be undone.</p>`,o.modalActionBtn.textContent="Confirm Delete",o.modalActionBtn.className="btn btn-primary bg-red-600 hover:bg-red-700";break;case"confirmDeleteConversation":o.modalTitle.textContent="Confirm Deletion",o.modalContent.innerHTML='<p>Are you sure you want to permanently delete this conversation and all of its messages?</p><p class="mt-2 text-sm text-red-700 bg-red-100 p-3 rounded-lg">This action cannot be undone.</p>',o.modalActionBtn.textContent="Yes, Delete Conversation",o.modalActionBtn.className="btn btn-primary bg-red-600 hover:bg-red-700",o.modalCancelBtn.textContent="Cancel";break;case"timeout":o.modalTitle.textContent="Session Ended",o.modalContent.innerHTML="<p>Your work has been saved automatically. For your security, please sign in to continue.</p>",o.modalActionBtn.textContent="Continue",o.modalCancelBtn.style.display="none",o.modalActionBtn.onclick=_;break;case"sharing":o.modalTitle.textContent="Share Your Plan",o.modalContent.innerHTML='<div class="flex items-center justify-center p-8"><div class="loading-spinner"></div><p class="ml-4 text-gray-600">Generating secure link...</p></div>',o.modalActionBtn.style.display="none",o.modalCancelBtn.textContent="Cancel";break;case"aiActionPlan_generate":o.modalTitle.textContent="Generating AI Action Plan",o.modalContent.innerHTML='<div class="flex flex-col items-center justify-center p-8"><div class="loading-spinner"></div><p class="mt-4 text-gray-600">Please wait, the AI is creating your plan...</p></div>',o.modalActionBtn.style.display="none",o.modalCancelBtn.textContent="Cancel";break;case"aiActionPlan_view":o.modalTitle.textContent="Edit Your Action Plan",d.style.justifyContent="space-between";const l=document.createElement("div");l.className="undo-redo-container dynamic-btn",l.innerHTML='<button id="undo-btn" class="btn btn-secondary btn-icon" title="Undo"><i class="bi bi-arrow-counterclockwise"></i></button><button id="redo-btn" class="btn btn-secondary btn-icon" title="Redo"><i class="bi bi-arrow-clockwise"></i></button>',d.insertBefore(l,d.firstChild),l.querySelector("#undo-btn").onclick=lt,l.querySelector("#redo-btn").onclick=rt;const m=document.createElement("button");m.className="btn btn-secondary dynamic-btn",m.innerHTML='<i class="bi bi-stars"></i> Generate New',m.onclick=ct;const p=document.createElement("button");p.className="btn btn-secondary dynamic-btn",p.innerHTML='<i class="bi bi-printer-fill"></i> Print Plan',p.onclick=()=>{const u=document.getElementById("ai-printable-area").querySelector(".ai-tabs-content > div.active");if(!u){alert("Could not find active month to print.");return}const b=document.querySelector(".ai-tabs-nav .ai-tab-btn.active")?.textContent||"Action Plan",f=u.cloneNode(!0);f.querySelectorAll(".actions-cell, tfoot").forEach(E=>E.remove());const h="@page { size: A4; margin: 25mm; } body { font-family: 'DM Sans', sans-serif; } .print-header { text-align: center; border-bottom: 2px solid #D10A11; padding-bottom: 15px; margin-bottom: 25px; } h1 { font-family: 'Poppins', sans-serif; } h2 { font-family: 'Poppins', sans-serif; color: #D10A11; } table { width: 100%; border-collapse: collapse; font-size: 9pt; } th, td { border: 1px solid #E5E7EB; padding: 10px; text-align: left; } thead { display: table-header-group; }",y=window.open("","","height=800,width=1200");y.document.write(`<html><head><title>${b}</title><style>${h}</style></head><body>`),y.document.write(`<div class="print-header"><h1>${b}</h1><h2>Our Bakery Action Plan</h2><p>${S.planData.planName} | ${S.planData.bakeryLocation}</p></div>`),y.document.write(f.innerHTML),y.document.write("</body></html>"),y.document.close(),setTimeout(()=>y.print(),500)},o.modalActionBtn.textContent="Save Changes",o.modalActionBtn.onclick=dt,d.insertBefore(m,o.modalActionBtn),d.insertBefore(p,o.modalActionBtn),o.modalCancelBtn.style.display="none",j();break;case"confirmRegenerate":o.modalTitle.textContent="Are you sure?",o.modalContent.innerHTML="<p>Generating a new plan will overwrite your existing action plan and any edits. This cannot be undone.</p>",o.modalActionBtn.textContent="Yes, Generate New",o.modalActionBtn.className="btn btn-primary bg-red-600 hover:bg-red-700",o.modalActionBtn.onclick=()=>{delete S.planData.aiActionPlan,R?R(!0,{aiActionPlan:firebase.firestore.FieldValue.delete()}).then(()=>{ye(S,R,null)}):console.error("Save function is not available for regenerating AI Plan.")},o.modalCancelBtn.textContent="Cancel",o.modalCancelBtn.onclick=()=>{P("aiActionPlan_view");const u=A.length>0?A[A.length-1]:S.planData.aiActionPlan||"";document.getElementById("modal-content").innerHTML=`<div id="ai-printable-area" class="editable-action-plan">${u}</div>`,ge(document.getElementById("ai-printable-area"))};break;case"confirmClose":o.modalTitle.textContent="Discard Changes?",o.modalContent.innerHTML="<p>You have unsaved changes. Are you sure you want to close without saving?</p>",o.modalActionBtn.textContent="Discard",o.modalActionBtn.className="btn btn-primary bg-red-600 hover:bg-red-700",o.modalActionBtn.onclick=()=>_(),o.modalCancelBtn.textContent="Cancel",o.modalCancelBtn.onclick=()=>{P("aiActionPlan_view");const u=A[A.length-1];document.getElementById("modal-content").innerHTML=`<div id="ai-printable-area" class="editable-action-plan">${u}</div>`,ge(document.getElementById("ai-printable-area")),j()};break;case"confirmDeleteEvent":o.modalTitle.textContent="Confirm Deletion",o.modalContent.innerHTML=`<p>Are you sure you want to permanently delete the event: <strong class="font-bold">${r}</strong>?</p><p class="mt-2 text-sm text-red-700 bg-red-100 p-3 rounded-lg">This action cannot be undone.</p>`,o.modalActionBtn.textContent="Confirm Delete",o.modalActionBtn.className="btn btn-primary bg-red-600 hover:bg-red-700";break}o.modalOverlay.classList.remove("hidden")}function _(){o.modalOverlay.classList.add("hidden")}function pt(e,t){if(X=e,S=t,!o.modalCloseBtn||!o.mobileMenuBtn)return;o.modalCloseBtn.addEventListener("click",fe),o.modalOverlay.addEventListener("mousedown",i=>{i.target===o.modalOverlay&&fe()}),o.mobileMenuBtn.addEventListener("click",()=>o.appView.classList.toggle("sidebar-open")),o.sidebarOverlay.addEventListener("click",()=>o.appView.classList.remove("sidebar-open"));let n=0;const s=50;o.mainContent.addEventListener("touchstart",i=>{n=i.changedTouches[0].screenX},{passive:!0}),o.mainContent.addEventListener("touchend",i=>{i.changedTouches[0].screenX>n+s&&o.appView.classList.add("sidebar-open")}),o.sidebar.addEventListener("touchstart",i=>{n=i.changedTouches[0].screenX},{passive:!0}),o.sidebar.addEventListener("touchend",i=>{i.changedTouches[0].screenX<n-s&&o.appView.classList.remove("sidebar-open")}),o.radialMenuFab&&(o.radialMenuFab.addEventListener("click",()=>o.radialMenuContainer.classList.toggle("open")),o.radialMenuOverlay.addEventListener("click",()=>o.radialMenuContainer.classList.remove("open"))),localStorage.getItem("gails_cookie_consent")===null&&o.cookieBanner.classList.remove("hidden"),o.acceptBtn.addEventListener("click",()=>{localStorage.setItem("gails_cookie_consent","true"),o.cookieBanner.classList.add("hidden")}),o.declineBtn.addEventListener("click",()=>{localStorage.setItem("gails_cookie_consent","false"),o.cookieBanner.classList.add("hidden")});const a=document.getElementById("chat-input");a&&a.addEventListener("input",()=>{a.style.height="auto",a.style.height=`${a.scrollHeight}px`})}let T,M,K=[],q=null;const v={modal:document.getElementById("gemini-chat-modal"),modalBox:document.querySelector("#gemini-chat-modal .chat-modal-box"),chatModalContent:document.querySelector("#gemini-chat-modal .chat-modal-content"),header:document.getElementById("chat-modal-header"),closeBtn:document.getElementById("chat-modal-close-btn"),optionsBtn:document.getElementById("chat-options-btn"),newChatBtn:document.getElementById("chat-new-btn"),conversationView:document.getElementById("chat-conversation-area"),welcomeScreen:document.getElementById("chat-welcome-screen"),chatInput:document.getElementById("chat-input"),sendBtn:document.getElementById("chat-send-btn"),historyPanel:document.getElementById("chat-history-panel"),historyList:document.getElementById("history-list")};function we(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").split(/\n\s*\n/).map(a=>{if(a=a.trim(),!a)return"";const i=a.split(`
`),r=i.every(d=>/^\s*\*/.test(d)),c=i.every(d=>/^\s*\d+\./.test(d));if(r||c){const d=r?"ul":"ol",l=i.map(m=>`<li>${m.replace(/^\s*(\*|\d+\.)\s*/,"")}</li>`).join("");return`<${d}>${l}</${d}>`}return`<p>${a.replace(/\n/g,"<br>")}</p>`}).join("")}function te(){v.modal&&v.modal.classList.add("hidden")}function be(e,t,n=!1){v.welcomeScreen.classList.add("hidden"),v.historyPanel.classList.add("hidden"),v.conversationView.classList.remove("hidden");const s=document.createElement("div");s.className=`chat-message-wrapper justify-${e==="user"?"end":"start"}`;const a=document.createElement("div");a.className=`chat-bubble ${e==="user"?"user-bubble":"ai-bubble"}`,n?a.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div>':e==="user"?a.textContent=t:a.innerHTML=we(t),s.appendChild(a),v.conversationView.appendChild(s),s.scrollIntoView({behavior:"smooth",block:"start"})}function ke(e){const t=v.conversationView.querySelectorAll(".ai-bubble");if(t.length>0){const n=t[t.length-1];n.innerHTML=we(e),n.parentElement.scrollIntoView({behavior:"smooth",block:"start"})}}function Ee(){q=null,K=[],sessionStorage.removeItem("gails_lastConversationId"),v.conversationView.innerHTML="",ie()}async function Ce(e){if(!T.currentUser||!T.currentPlanId||!M)return;const t=M.collection("users").doc(T.currentUser.uid).collection("plans").doc(T.currentPlanId).collection("conversations");if(!q){const s=t.doc();q=s.id,sessionStorage.setItem("gails_lastConversationId",q),await s.set({firstMessage:e.text,createdAt:firebase.firestore.FieldValue.serverTimestamp()})}const n=t.doc(q).collection("messages");try{await n.add({...e,timestamp:firebase.firestore.FieldValue.serverTimestamp()})}catch(s){console.error("Error saving chat message:",s)}}async function re(){const e=v.chatInput.value.trim();if(!e)return;const t={role:"user",parts:[{text:e}]};K.push(t),be("user",e),Ce({role:"user",text:e});const n=v.chatInput.scrollHeight;v.chatInput.value="",v.chatInput.style.height=`${n}px`,be("model","",!0);try{const s=he(T.planData),a=T.calendar.data,i=await Xe(s,K,e,a);ke(i);const r={role:"model",parts:[{text:i}]};K.push(r),Ce({role:"model",text:i})}catch(s){console.error("Chat error:",s);const a=s.message||"Sorry, I encountered an error. Please try again.";ke(a)}}async function Ue(e){if(!T.currentUser||!T.currentPlanId||!M)return;v.conversationView.innerHTML="",q=e,sessionStorage.setItem("gails_lastConversationId",e);const t=M.collection("users").doc(T.currentUser.uid).collection("plans").doc(T.currentPlanId).collection("conversations").doc(e).collection("messages").orderBy("timestamp","asc");try{const n=await t.get(),s=[],a=document.createDocumentFragment();n.forEach(r=>{const c=r.data();s.push({role:c.role,parts:[{text:c.text}]});const d=document.createElement("div");d.className=`chat-message-wrapper justify-${c.role==="user"?"end":"start"}`;const l=document.createElement("div");l.className=`chat-bubble ${c.role==="user"?"user-bubble":"ai-bubble"}`,c.role==="user"?l.textContent=c.text:l.innerHTML=we(c.text),d.appendChild(l),a.appendChild(d)}),K=s,v.conversationView.appendChild(a),ie();const i=v.conversationView.lastElementChild;i&&i.scrollIntoView({behavior:"auto",block:"start"})}catch(n){console.error("Error loading chat history:",n),be("model","Could not load previous messages.")}}function ie(){v.historyPanel.classList.add("hidden");const e=v.optionsBtn.querySelector("i");e.className="bi bi-clock-history",v.optionsBtn.title="View History",K.length===0?(v.welcomeScreen.classList.remove("hidden"),v.conversationView.classList.add("hidden")):(v.welcomeScreen.classList.add("hidden"),v.conversationView.classList.remove("hidden"))}async function gt(e){if(!T.currentUser||!T.currentPlanId||!M)return;const t=M.collection("users").doc(T.currentUser.uid).collection("plans").doc(T.currentPlanId).collection("conversations").doc(e);try{await t.delete();const n=v.historyList.querySelector(`.history-item[data-id="${e}"]`);n&&n.remove(),q===e&&Ee()}catch(n){console.error("Error deleting conversation:",n),alert("Failed to delete conversation. Please try again.")}}async function ft(){v.welcomeScreen.classList.add("hidden"),v.conversationView.classList.add("hidden"),v.historyPanel.classList.remove("hidden");const e=v.optionsBtn.querySelector("i");if(e.className="bi bi-arrow-left",v.optionsBtn.title="Back to Chat",v.historyList.innerHTML='<div class="loading-spinner mx-auto mt-8"></div>',!T.currentUser||!T.currentPlanId||!M){v.historyList.innerHTML='<p class="text-center text-gray-500 p-4">Could not load history.</p>';return}const t=M.collection("users").doc(T.currentUser.uid).collection("plans").doc(T.currentPlanId).collection("conversations").orderBy("createdAt","desc");try{const n=await t.get();if(n.empty){v.historyList.innerHTML='<p class="text-center text-gray-500 p-4">No past conversations found.</p>';return}v.historyList.innerHTML="",n.forEach(s=>{const a=s.data(),i=document.createElement("div");i.className="history-item",i.dataset.id=s.id,i.innerHTML=`
                <div class="history-item-text">
                    <p class="history-item-title">${a.firstMessage}</p>
                    <p class="history-item-date">${a.createdAt.toDate().toLocaleDateString()}</p>
                </div>
                <button class="btn btn-secondary btn-icon delete-conversation-btn" title="Delete conversation" data-id="${s.id}">
                    <i class="bi bi-trash3"></i>
                </button>
            `,v.historyList.appendChild(i)})}catch(n){console.error("Error fetching conversation list:",n),v.historyList.innerHTML='<p class="text-center text-red-500 p-4">Failed to load conversation history.</p>'}}async function bt(){if(v.modal){await De(M,T),v.modal.classList.remove("hidden"),v.chatInput.focus();const e=sessionStorage.getItem("gails_lastConversationId");e&&e!=="null"?q!==e?Ue(e):ie():Ee()}}function vt(e,t){T=e,M=t,v.modal&&(v.modal.addEventListener("click",n=>{n.target===v.modal&&te()}),v.closeBtn.addEventListener("click",te),window.addEventListener("keydown",n=>{n.key==="Escape"&&!v.modal.classList.contains("hidden")&&te()}),v.sendBtn.addEventListener("click",re),v.chatInput.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),re())}),v.welcomeScreen.addEventListener("click",n=>{const s=n.target.closest(".prompt-starter-card");if(s){const a=s.querySelector("p:last-child").textContent.replace(/"/g,"");v.chatInput.value=a,v.chatInput.focus(),re()}}),v.newChatBtn.addEventListener("click",Ee),v.historyList.addEventListener("click",n=>{const s=n.target.closest(".history-item"),a=n.target.closest(".delete-conversation-btn");if(a){n.stopPropagation();const i=a.dataset.id;P("confirmDeleteConversation",{planId:i})}else if(s){const i=s.dataset.id;Ue(i)}}),document.addEventListener("conversation-deletion-confirmed",n=>{const{conversationId:s}=n.detail;s&&gt(s)}),v.optionsBtn.addEventListener("click",()=>{!v.historyPanel.classList.contains("hidden")?ie():ft()}),document.addEventListener("logout-request",te))}let Fe,V,H,Q,$e,F,de=null;function ht(e){const t=document.createElement("div");t.className="file-item",t.dataset.fileId=e.id;const n={pdf:"bi-file-earmark-pdf-fill",doc:"bi-file-earmark-word-fill",docx:"bi-file-earmark-word-fill",xls:"bi-file-earmark-excel-fill",xlsx:"bi-file-earmark-excel-fill",default:"bi-file-earmark-text-fill"},s=e.name.split(".").pop().toLowerCase(),a=n[s]||n.default,i=e.uploadedAt?.toDate?e.uploadedAt.toDate().toLocaleDateString("en-GB"):"Just now";return t.innerHTML=`
        <div class="file-thumbnail">
            <i class="bi ${a}"></i>
        </div>
        <div class="file-info">
            <p class="file-name">${e.name}</p>
            <p class="file-metadata">${i}</p>
        </div>
    `,t}function yt(){de&&de(),de=Fe.collection("users").doc(V.currentUser.uid).collection("plans").doc(V.currentPlanId).collection("files").orderBy("uploadedAt","desc").onSnapshot(t=>{t.empty?(F.classList.remove("hidden"),Q.innerHTML="",Q.appendChild(F)):(F.classList.add("hidden"),Q.innerHTML="",t.forEach(n=>{const s=ht({id:n.id,...n.data()});Q.appendChild(s)}))},t=>{console.error("Error fetching files:",t),F.classList.remove("hidden"),F.querySelector("p").textContent="Could not load files."})}function Te(e){if(!(!e||e.length===0)){if(!V.currentUser||!V.currentPlanId){console.error("User or plan not identified. Cannot upload file.");return}F.classList.add("hidden"),Array.from(e).forEach(async t=>{const n=document.createElement("div");n.className="file-item",n.innerHTML=`
            <div class="file-thumbnail">
                <div class="loading-spinner"></div>
            </div>
            <div class="file-info">
                <p class="file-name">${t.name}</p>
                <p class="file-metadata">Uploading...</p>
            </div>
        `,Q.prepend(n);const s=new FormData;s.append("file",t),s.append("planId",V.currentPlanId),s.append("userId",V.currentUser.uid);try{const a=await fetch("/.netlify/functions/upload-file",{method:"POST",body:s});if(!a.ok)throw new Error(`Upload failed with status: ${a.status}`);n.remove()}catch(a){console.error("Upload failed:",a),n.remove(),alert(`Error uploading ${t.name}. Please try again.`)}})}}function wt(){H=document.getElementById("file-drop-zone"),Q=document.getElementById("file-grid-container"),$e=document.getElementById("file-upload-input"),F=document.querySelector(".file-item-placeholder"),H&&(H.addEventListener("dragover",e=>{e.preventDefault(),H.classList.add("is-active")}),H.addEventListener("dragleave",()=>{H.classList.remove("is-active")}),H.addEventListener("drop",e=>{e.preventDefault(),H.classList.remove("is-active"),Te(e.dataTransfer.files)}),$e.addEventListener("change",e=>{Te(e.target.files),e.target.value=""}))}function Et(){wt(),yt()}function xt(e,t,n){Fe=e,V=n}let W,g,ve,ce,Ae,xe=[];const k={appView:document.getElementById("app-view"),contentArea:document.getElementById("content-area"),mainContent:document.querySelector("#app-view main"),mainNav:document.getElementById("main-nav"),headerTitle:document.getElementById("header-title"),headerSubtitle:document.getElementById("header-subtitle"),sidebarName:document.getElementById("sidebar-name"),sidebarBakery:document.getElementById("sidebar-bakery"),sidebarInitials:document.getElementById("sidebar-initials"),progressBarFill:document.getElementById("progress-bar-fill"),progressPercentage:document.getElementById("progress-percentage"),backToDashboardBtn:document.getElementById("back-to-dashboard-btn"),sidebarLogoutBtn:document.getElementById("sidebar-logout-btn"),printBtn:document.getElementById("print-btn"),shareBtn:document.getElementById("share-btn"),aiActionBtn:document.getElementById("ai-action-btn"),desktopHeaderButtons:document.getElementById("desktop-header-buttons"),saveIndicator:document.getElementById("save-indicator")},me={vision:{html:`<div class="space-y-8">
                        <div class="bg-amber-50 border border-amber-200 rounded-xl p-6 shadow-sm"><h3 class="font-bold text-lg text-amber-900 mb-2">Our Mission</h3><p class="text-xl font-semibold text-gray-800">"To make world-class, craft baking a part of every neighbourhood."</p></div>
                        <div class="content-card p-8"><label for="quarterlyTheme" class="block text-lg font-semibold mb-2">Quarterly Vision: <i class="bi bi-info-circle info-icon" title="The big, overarching mission for the next 90 days."></i></label><div id="quarterlyTheme" class="form-input is-placeholder-showing" contenteditable="true" data-placeholder="e.g., Become the undisputed neighbourhood favourite by mastering our availability." data-maxlength="400"></div></div>
                        <div class="content-card p-8"><h3 class="text-2xl font-bold mb-6">Key Monthly Objectives</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div><label for="month1Goal" class="font-bold block mb-1">Month 1: <i class="bi bi-info-circle info-icon" title="High-level goal for the first 30-day sprint."></i></label><div id="month1Goal" class="form-input text-sm is-placeholder-showing" contenteditable="true" data-placeholder="e.g., PRODUCT: Master afternoon availability and reduce waste." data-maxlength="300"></div></div><div><label for="month2Goal" class="font-bold block mb-1">Month 2: <i class="bi bi-info-circle info-icon" title="High-level goal for the second 30-day sprint."></i></label><div id="month2Goal" class="form-input text-sm is-placeholder-showing" contenteditable="true" data-placeholder="e.g., PLACE: Embed new production processes and daily checks." data-maxlength="300"></div></div><div><label for="month3Goal" class="font-bold block mb-1">Month 3: <i class="bi bi-info-circle info-icon" title="High-level goal for the third 30-day sprint."></i></label><div id="month3Goal" class="form-input text-sm is-placeholder-showing" contenteditable="true" data-placeholder="e.g., PEOPLE: Develop team skills for consistent execution." data-maxlength="300"></div></div></div></div>
                   </div>`,requiredFields:["quarterlyTheme","month1Goal","month2Goal","month3Goal"]},month:e=>`
            <div class="space-y-8">
                <div class="content-card p-6 md:p-8">
                    <h2 class="text-2xl font-bold font-poppins mb-1">Your Foundation</h2>
                    <p class="text-gray-600 mb-6">Complete these sections at the start of your month to set a clear direction.</p>
                    <div class="space-y-6">
                        <div>
                            <label class="font-semibold text-lg block mb-2 text-gray-800">Must-Win Battle:</label>
                            <div id="m${e}s1_battle" class="form-input is-placeholder-showing" contenteditable="true" data-placeholder="Example: 'Achieve >80% availability by implementing the production matrix correctly...'" data-maxlength="500"></div>
                            <div class="mt-4">
                                <label class="font-semibold block mb-3 text-sm text-gray-600">Pillar Focus:</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 pillar-buttons" data-step-key="m${e}s1">
                                    <button class="btn pillar-button" data-pillar="people"><i class="bi bi-people-fill"></i> People</button>
                                    <button class="btn pillar-button" data-pillar="product"><i class="bi bi-cup-hot-fill"></i> Product</button>
                                    <button class="btn pillar-button" data-pillar="customer"><i class="bi bi-heart-fill"></i> Customer</button>
                                    <button class="btn pillar-button" data-pillar="place"><i class="bi bi-shop"></i> Place</button>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-6 border-t">
                            <div class="flex flex-col">
                                <label for="m${e}s2_levers" class="font-semibold text-lg block mb-2 text-gray-800">My Key Actions:</label>
                                <div id="m${e}s2_levers" class="form-input is-placeholder-showing flex-grow key-levers-input" contenteditable="true" data-placeholder="1. Daily: Review the production report from yesterday to adjust today's baking.&#10;2. Lead a 'Coffee calibration' session in the management meeting &#10;3. Ongoing: Coach one team member daily on a specific SHINE principle." data-maxlength="600"></div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="m${e}s2_powerup_q" class="font-semibold text-lg block mb-2 text-gray-800">Team Power-Up Question:</label>
                                    <div id="m${e}s2_powerup_q" class="form-input is-placeholder-showing" contenteditable="true" data-placeholder="What's one small change we could make this week to make our customers smile?" data-maxlength="300"></div>
                                </div>
                                <div>
                                    <label for="m${e}s2_powerup_a" class="font-semibold text-lg block mb-2 text-gray-800">Our Team's Winning Idea:</label>
                                    <div id="m${e}s2_powerup_a" class="form-input is-placeholder-showing" contenteditable="true" data-placeholder="Creating a 'regular's board' to remember our most frequent customers' orders." data-maxlength="300"></div>
                                </div>
                            </div>
                        </div>
                        <div class="pt-6 border-t">
                            <label class="font-semibold text-lg block mb-2 text-gray-800">Developing Our Breadheads:</label>
                            <div id="m${e}s3_people" class="form-input is-placeholder-showing" contenteditable="true" data-placeholder="Example: 'Sarah: Coach on the production matrix to build her confidence.'" data-maxlength="600"></div>
                        </div>
                        <div class="pt-6 border-t">
                            <label class="font-semibold text-lg block mb-2 text-gray-800">Upholding Our Pillars:</label>
                            <p class="text-gray-600 mb-4 -mt-2 text-sm">One key behaviour for each pillar to ensure standards don't slip.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                <div><label for="m${e}s4_people" class="font-semibold block mb-2 flex items-center gap-2"><i class="bi bi-people-fill"></i> PEOPLE</label><div id="m${e}s4_people" class="form-input is-placeholder-showing" contenteditable="true" data-placeholder="e.g., Meaningful 1-2-1s with my two keyholders." data-maxlength="300"></div></div>
                                <div><label for="m${e}s4_product" class="font-semibold block mb-2 flex items-center gap-2"><i class="bi bi-cup-hot-fill"></i> PRODUCT</label><div id="m${e}s4_product" class="form-input is-placeholder-showing" contenteditable="true" data-placeholder="e.g., Daily quality checks of the first bake." data-maxlength="300"></div></div>
                                <div><label for="m${e}s4_customer" class="font-semibold block mb-2 flex items-center gap-2"><i class="bi bi-heart-fill"></i> CUSTOMER</label><div id="m${e}s4_customer" class="form-input is-placeholder-showing" contenteditable="true" data-placeholder="e.g., Action all customer feedback within 24 hours." data-maxlength="300"></div></div>
                                <div><label for="m${e}s4_place" class="font-semibold block mb-2 flex items-center gap-2"><i class="bi bi-shop"></i> PLACE</label><div id="m${e}s4_place" class="form-input is-placeholder-showing" contenteditable="true" data-placeholder="e.g., Complete a bakery travel path twice a day." data-maxlength="300"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="content-card p-6 md:p-8">
                    <h2 class="text-2xl font-bold font-poppins mb-1">Weekly Momentum</h2>
                    <p class="text-gray-600 mb-6">Return here each week to log your progress, celebrate wins, and spotlight your team.</p>
                    <div class="mb-6 border-b border-gray-200">
                        <nav id="weekly-tabs" class="flex -mb-px space-x-6" aria-label="Tabs">
                            ${[1,2,3,4].map(t=>`
                                <a href="#" class="weekly-tab ${t===1?"active":""} flex items-center" data-week="${t}">
                                    <span>Week ${t}</span>
                                    <i class="bi bi-check-circle-fill week-complete-icon ml-2 hidden"></i>
                                </a>
                            `).join("")}
                        </nav>
                    </div>
                    <div id="weekly-tab-content">
                        ${[1,2,3,4].map(t=>`
                            <div class="weekly-tab-panel ${t!==1?"hidden":""}" data-week-panel="${t}">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
                                    <div class="md:col-span-2"><label id="weekly-progress-label-${t}" class="font-semibold block mb-3 text-gray-700">Week ${t} Progress:</label><div class="flex items-center space-x-2 status-buttons" data-week="${t}"><button class="status-button" data-status="on-track">ON TRACK</button><button class="status-button" data-status="issues">ISSUES</button><button class="status-button" data-status="off-track">OFF TRACK</button></div></div>
                                    <div><label for="m${e}s5_w${t}_win" class="font-semibold block mb-2 text-gray-700">A Win or Learning:</label><div id="m${e}s5_w${t}_win" class="form-input text-sm is-placeholder-showing weekly-check-in-input" contenteditable="true" data-placeholder="e.g., The team hit 80% availability on Thursday!" data-maxlength="400"></div></div>
                                    <div><label for="m${e}s5_w${t}_spotlight" class="font-semibold block mb-2 text-gray-700">Breadhead Spotlight:</label><div id="m${e}s5_w${t}_spotlight" class="form-input text-sm is-placeholder-showing weekly-check-in-input" contenteditable="true" data-placeholder="e.g., Sarah, for making a customer's day by remembering their name and usual order—a perfect example of our SHINE values." data-maxlength="400"></div></div>
                                    <div class="md:col-span-2"><label for="m${e}s5_w${t}_shine" class="font-semibold block mb-2 text-gray-700">This Week's SHINE Focus:</label><div id="m${e}s5_w${t}_shine" class="form-input text-sm is-placeholder-showing weekly-check-in-input" contenteditable="true" data-placeholder="e.g., Ensuring every customer is greeted within 30 seconds." data-maxlength="400"></div></div>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                </div>
                <div class="content-card p-6 md:p-8 bg-red-50 border border-red-100">
                    <h2 class="text-2xl font-bold font-poppins mb-1">End of Month Review</h2>
                    <p class="text-gray-600 mb-6">At the end of the month, reflect on your performance to prepare for your line manager conversation.</p>
                    <div class="space-y-6">
                        <div><label for="m${e}s6_win" class="font-semibold block mb-1 text-lg gails-red-text flex items-center gap-2"><i class="bi bi-trophy-fill"></i> Biggest Win:</label><div id="m${e}s6_win" class="form-input is-placeholder-showing" contenteditable="true" data-maxlength="500"></div></div>
                        <div><label for="m${e}s6_challenge" class="font-semibold block mb-1 text-lg gails-red-text flex items-center gap-2"><i class="bi bi-lightbulb-fill"></i> Toughest Challenge & What I Learned:</label><div id="m${e}s6_challenge" class="form-input is-placeholder-showing" contenteditable="true" data-maxlength="500"></div></div>
                        <div><label for="m${e}s6_next" class="font-semibold block mb-1 text-lg gails-red-text flex items-center gap-2"><i class="bi bi-rocket-takeoff-fill"></i> Focus for Next Month:</label><div id="m${e}s6_next" class="form-input is-placeholder-showing" contenteditable="true" data-maxlength="500"></div></div>
                    </div>
                </div>
                ${e==3?`
                <div class="content-card p-8" style="background-color: var(--review-blue-bg); border-color: var(--review-blue-border);">
                    <h2 class="text-2xl font-bold font-poppins mb-1" style="color: var(--review-blue-text);">Final Quarterly Reflection</h2>
                    <p class="text-gray-600 mb-6">A deep dive into the quarter's performance for your review.</p>
                    <div class="space-y-6">
                        <div><label for="m3s7_achievements" class="font-semibold block mb-1 text-lg" style="color: var(--review-blue-text);"><i class="bi bi-award-fill"></i> Quarter's Biggest Achievements:</label><div id="m3s7_achievements" class="form-input is-placeholder-showing" contenteditable="true" data-maxlength="800"></div></div>
                        <div><label for="m3s7_challenges" class="font-semibold block mb-1 text-lg" style="color: var(--review-blue-text);"><i class="bi bi-bar-chart-line-fill"></i> Biggest Challenges & Learnings:</label><div id="m3s7_challenges" class="form-input is-placeholder-showing" contenteditable="true" data-maxlength="800"></div></div>
                        <div><label for="m3s7_narrative" class="font-semibold block mb-1 text-lg" style="color: var(--review-blue-text);"><i class="bi bi-bullseye"></i> Performance vs Quarterly Narrative:</label><div id="m3s7_narrative" class="form-input is-placeholder-showing" contenteditable="true" data-maxlength="800"></div></div>
                        <div><label for="m3s7_next_quarter" class="font-semibold block mb-1 text-lg" style="color: var(--review-blue-text);"><i class="bi bi-forward-fill"></i> Primary Focus for Next Quarter:</label><div id="m3s7_next_quarter" class="form-input is-placeholder-showing" contenteditable="true" data-maxlength="800"></div></div>
                    </div>
                </div>`:""}
            </div>
        `,files:{html:`
            <div class="space-y-8">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="search-wrapper flex-grow max-w-lg">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" id="file-search-input" class="form-input" placeholder="Search files by name...">
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="file-filter-btn" class="btn btn-secondary"><i class="bi bi-funnel-fill"></i> Filter</button>
                        <label for="file-upload-input" class="btn btn-primary cursor-pointer">
                            <i class="bi bi-upload"></i>
                            <span>Upload File</span>
                        </label>
                        <input type="file" id="file-upload-input" class="hidden" multiple>
                    </div>
                </div>

                <div id="file-drop-zone" class="file-drop-zone">
                    <div id="file-grid-container" class="file-grid">
                        <div class="file-item-placeholder">
                            <i class="bi bi-cloud-arrow-up"></i>
                            <p class="font-semibold mt-2">Drag & drop files here</p>
                            <p class="text-sm text-gray-500">or use the upload button</p>
                        </div>
                    </div>
                </div>
            </div>
        `}};function he(e){const t=s=>{if(!s)return"";const a=document.createElement("div");return a.innerHTML=s,a.innerText.trim()};let n=`MANAGER: ${t(e.managerName)}
`;n+=`BAKERY: ${t(e.bakeryLocation)}
`,n+=`QUARTER: ${t(e.quarter)}
`,n+=`QUARTERLY VISION: ${t(e.quarterlyTheme)}

`;for(let s=1;s<=3;s++){n+=`--- MONTH ${s} ---
`,n+=`GOAL: ${t(e[`month${s}Goal`])}
`;const a=e[`m${s}s1_pillar`];Array.isArray(a)&&a.length>0&&(n+=`PILLAR FOCUS: ${a.join(", ")}
`),n+=`MUST-WIN BATTLE: ${t(e[`m${s}s1_battle`])}
`,n+=`KEY ACTIONS: ${t(e[`m${s}s2_levers`])}
`,n+=`TEAM POWER-UP QUESTION: ${t(e[`m${s}s2_powerup_q`])}
`,n+=`TEAM'S WINNING IDEA: ${t(e[`m${s}s2_powerup_a`])}
`,n+=`DEVELOPING OUR BREADHEADS: ${t(e[`m${s}s3_people`])}
`,n+=`UPHOLDING PILLARS (PEOPLE): ${t(e[`m${s}s4_people`])}
`,n+=`UPHOLDING PILLARS (PRODUCT): ${t(e[`m${s}s4_product`])}
`,n+=`UPHOLDING PILLARS (CUSTOMER): ${t(e[`m${s}s4_customer`])}
`,n+=`UPHOLDING PILLARS (PLACE): ${t(e[`m${s}s4_place`])}

`}return n}function Lt(){xe=Array.from(document.querySelectorAll('#app-view input, #app-view [contenteditable="true"]'))}function ne(e=!1,t=null){if(!g.currentUser||!g.currentPlanId||(t&&(g.planData={...g.planData,...t}),g.isSaving))return Promise.resolve();clearTimeout(g.saveTimeout);const n=async()=>{g.isSaving=!0;const s=W.collection("users").doc(g.currentUser.uid).collection("plans").doc(g.currentPlanId),a={...g.planData};delete a.isSaving,await s.set({...a,lastEdited:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),k.saveIndicator.classList.remove("opacity-0"),setTimeout(()=>k.saveIndicator.classList.add("opacity-0"),2e3),g.isSaving=!1};return e?n():new Promise(s=>{g.saveTimeout=setTimeout(async()=>{await n(),s()},1e3)})}function Bt(){if(xe.forEach(e=>{e.isContentEditable?e.innerHTML=g.planData[e.id]||"":e.value=g.planData[e.id]||""}),document.querySelectorAll(".pillar-buttons").forEach(e=>{const n=`${e.dataset.stepKey}_pillar`,s=g.planData[n]||[];e.querySelectorAll(".selected").forEach(a=>a.classList.remove("selected")),s.forEach(a=>{const i=e.querySelector(`[data-pillar="${a}"]`);i&&i.classList.add("selected")})}),g.currentView.startsWith("month-")){const e=g.currentView.split("-")[1];document.querySelectorAll(".status-buttons").forEach(t=>{const n=t.dataset.week,s=`m${e}s5_w${n}_status`,a=g.planData[s];if(t.querySelectorAll(".selected").forEach(i=>i.classList.remove("selected")),a){const i=t.querySelector(`[data-status="${a}"]`);i&&i.classList.add("selected")}})}document.querySelectorAll('#app-view [contenteditable="true"]').forEach(e=>{e.innerText.trim()===""?e.classList.add("is-placeholder-showing"):e.classList.remove("is-placeholder-showing")})}function It(e){if(g.currentView==="summary"){Re();return}if(!k.appView.classList.contains("hidden")){if(g.currentView.startsWith("month-")){const t=parseInt(g.currentView.split("-")[1],10);Ve(t,e)}if(xe.forEach(t=>{document.activeElement!==t&&t.id&&e[t.id]!==void 0&&(t.isContentEditable?t.innerHTML!==e[t.id]&&(t.innerHTML=e[t.id]):t.value!==e[t.id]&&(t.value=e[t.id])),t.isContentEditable&&(t.innerText.trim()===""?t.classList.add("is-placeholder-showing"):t.classList.remove("is-placeholder-showing"))}),document.querySelectorAll(".pillar-buttons").forEach(t=>{const s=`${t.dataset.stepKey}_pillar`,a=e[s];t.querySelectorAll(".selected").forEach(i=>i.classList.remove("selected")),Array.isArray(a)&&a.forEach(i=>{const r=t.querySelector(`[data-pillar="${i}"]`);r&&r.classList.add("selected")})}),g.currentView.startsWith("month-")){const t=g.currentView.split("-")[1];document.querySelectorAll(".status-buttons").forEach(n=>{const s=n.dataset.week,a=`m${t}s5_w${s}_status`,i=e[a];if(n.querySelectorAll(".selected").forEach(r=>r.classList.remove("selected")),i){const r=n.querySelector(`[data-status="${i}"]`);r&&r.classList.add("selected")}})}}}function Ve(e,t){for(let n=1;n<=4;n++){const s=at(e,n,t),a=document.querySelector(`.weekly-tab[data-week="${n}"]`);if(a){const i=a.querySelector(".week-complete-icon");i&&i.classList.toggle("hidden",!s)}}}function kt(){const e=(t,n)=>{const s=document.querySelector(t);if(!s)return;const a=n.total>0&&n.completed===n.total;s.classList.toggle("completed",a);const i=s.querySelector(".progress-donut__progress");if(i){const r=i.r.baseVal.value,c=2*Math.PI*r;i.style.strokeDasharray=`${c} ${c}`;const d=n.total>0?n.completed/n.total:0,l=c-d*c;i.style.strokeDashoffset=l}};e("#nav-vision",Me(g.planData));for(let t=1;t<=3;t++)e(`#nav-month-${t}`,_e(t,g.planData))}function Ct(){const e=He(g.planData);k.progressPercentage.textContent=`${e}%`,k.progressBarFill.style.width=`${e}%`}function $t(){const e=g.planData.managerName||"";if(k.sidebarName.textContent=e||"Your Name",k.sidebarBakery.textContent=g.planData.bakeryLocation||"Your Bakery",e){const t=e.trim().split(" "),n=t[0]?t[0][0]:"",s=t.length>1?t[t.length-1][0]:"";k.sidebarInitials.textContent=(n+s).toUpperCase()}else k.sidebarInitials.textContent="--"}function Se(){$t(),Ct(),kt();const e=document.getElementById("sidebar-plan-context");e&&(e.textContent=`${g.planData.quarter||"Your"} Plan`)}function Re(){const e=g.planData,t=s=>{if(!s)return"...";const a=document.createElement("div");return a.innerHTML=s,a.innerText.trim()===""?"...":s},n=s=>{let a="<ul>",i=!1;for(let m=1;m<=4;m++){const p=e[`m${s}s5_w${m}_status`],u=e[`m${s}s5_w${m}_win`],b=e[`m${s}s5_w${m}_spotlight`],f=e[`m${s}s5_w${m}_shine`];if(p){i=!0;const h=p.replace("-"," ").toUpperCase(),y=`<span class="summary-status-badge status-${p}">${h}</span>`;let E="";U(u)||(E+=`<p class="text-sm text-gray-600 mb-2"><strong>Win/Learning:</strong> ${t(u)}</p>`),U(b)||(E+=`<p class="text-sm text-gray-600 mb-2"><strong>Breadhead Spotlight:</strong> ${t(b)}</p>`),U(f)||(E+=`<p class="text-sm text-gray-600"><strong>SHINE Focus:</strong> ${t(f)}</p>`),E===""&&(E='<p class="text-sm text-gray-500 italic">No details logged.</p>'),a+=`<li class="mb-3 pb-3 border-b last:border-b-0"><div class="flex justify-between items-center mb-2"><strong class="font-semibold text-gray-700">Week ${m}</strong>${y}</div>${E}</li>`}}i?a+="</ul>":a='<p class="text-sm text-gray-500">No weekly check-ins logged.</p>';const r=e[`m${s}s1_pillar`],c={people:"bi-people-fill",product:"bi-cup-hot-fill",customer:"bi-heart-fill",place:"bi-shop"};let d="";Array.isArray(r)&&r.length>0&&(d=r.map(m=>`<span class="pillar-badge"><i class="bi ${c[m]}"></i> ${m.charAt(0).toUpperCase()+m.slice(1)}</span>`).join(""));let l=d?`<div class="flex items-center gap-2 mb-4 flex-wrap"><span class="font-semibold text-sm text-gray-500">Pillar Focus:</span>${d}</div>`:"";return`<div class="content-card p-0 overflow-hidden mt-8">
            <h2 class="text-2xl font-bold font-poppins p-6 bg-gray-50 border-b">${s*30} Day Plan</h2>
            <div class="summary-grid">
                <div class="p-6">
                    ${l}
                    <div class="summary-section"><h3 class="summary-heading">Must-Win Battle</h3><div class="summary-content prose prose-sm">${t(e[`m${s}s1_battle`])}</div></div>
                    <div class="summary-section"><h3 class="summary-heading">Key Actions</h3><div class="summary-content prose prose-sm">${t(e[`m${s}s2_levers`])}</div></div>
                    <div class="summary-section"><h3 class="summary-heading">Developing Our Breadheads</h3><div class="summary-content prose prose-sm">${t(e[`m${s}s3_people`])}</div></div>
                </div>
                <div class="p-6 bg-gray-50/70 border-l">
                    <div class="summary-section"><h3 class="summary-heading">Upholding Pillars</h3><ul class="space-y-3 mt-2"><li class="flex items-start text-sm"><i class="bi bi-people-fill w-5 text-center mr-3 text-gray-400"></i><span class="flex-1">${t(e[`m${s}s4_people`])}</span></li><li class="flex items-start text-sm"><i class="bi bi-cup-hot-fill w-5 text-center mr-3 text-gray-400"></i><span class="flex-1">${t(e[`m${s}s4_product`])}</span></li><li class="flex items-start text-sm"><i class="bi bi-heart-fill w-5 text-center mr-3 text-gray-400"></i><span class="flex-1">${t(e[`m${s}s4_customer`])}</span></li><li class="flex items-start text-sm"><i class="bi bi-shop w-5 text-center mr-3 text-gray-400"></i><span class="flex-1">${t(e[`m${s}s4_place`])}</span></li></ul></div>
                    <div class="summary-section"><h3 class="summary-heading">Weekly Momentum</h3>${a}</div>
                    <div class="summary-section"><h3 class="summary-heading">End of Month Review</h3><ul class="space-y-3 mt-2"><li class="flex items-start text-sm"><i class="bi bi-trophy-fill w-5 text-center mr-3 text-gray-400"></i><span class="flex-1"><strong>Win:</strong> ${t(e[`m${s}s6_win`])}</span></li><li class="flex items-start text-sm"><i class="bi bi-lightbulb-fill w-5 text-center mr-3 text-gray-400"></i><span class="flex-1"><strong>Challenge:</strong> ${t(e[`m${s}s6_challenge`])}</span></li><li class="flex items-start text-sm"><i class="bi bi-rocket-takeoff-fill w-5 text-center mr-3 text-gray-400"></i><span class="flex-1"><strong>Next:</strong> ${t(e[`m${s}s6_next`])}</span></li></ul></div>
                </div>
            </div>
        </div>`};k.contentArea.innerHTML=`<div class="space-y-8 summary-content">
        <div class="content-card p-6"><h2 class="text-2xl font-bold font-poppins mb-4">Quarter Overview</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-b pb-4 mb-4"><div><h4 class="font-semibold text-sm text-gray-500">Manager</h4><p class="text-gray-800 font-medium">${e.managerName||"..."}</p></div><div><h4 class="font-semibold text-sm text-gray-500">Bakery</h4><p class="text-gray-800 font-medium">${e.bakeryLocation||"..."}</p></div><div><h4 class="font-semibold text-sm text-gray-500">Quarter</h4><p class="text-gray-800 font-medium">${e.quarter||"..."}</p></div></div><div class="mb-6"><h4 class="font-semibold text-sm text-gray-500">Quarterly Vision</h4><div class="text-gray-800 prose prose-sm">${t(e.quarterlyTheme)}</div></div><div><h3 class="text-lg font-bold border-b pb-2 mb-3">Key Monthly Objectives</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-3 text-sm"><div><strong class="font-semibold text-gray-600 block">Month 1:</strong><div class="text-gray-800 mt-1 prose prose-sm">${t(e.month1Goal)}</div></div><div><strong class="font-semibold text-gray-600 block">Month 2:</strong><div class="text-gray-800 mt-1 prose prose-sm">${t(e.month2Goal)}</div></div><div><strong class="font-semibold text-gray-600 block">Month 3:</strong><div class="text-gray-800 mt-1 prose prose-sm">${t(e.month3Goal)}</div></div></div></div></div>
        ${n(1)}
        ${n(2)}
        ${n(3)}
        <div class="content-card p-6 mt-8" style="background-color: var(--review-blue-bg); border-color: var(--review-blue-border);"><h2 class="text-2xl font-bold mb-4" style="color: var(--review-blue-text);">Final Quarterly Reflection</h2><div class="space-y-4"><div><h3 class="font-bold text-lg flex items-center gap-2" style="color: var(--review-blue-text);"><i class="bi bi-award-fill"></i> Biggest Achievements</h3><div class="text-gray-700 mt-1 prose prose-sm">${t(e.m3s7_achievements)}</div></div><div><h3 class="font-bold text-lg flex items-center gap-2" style="color: var(--review-blue-text);"><i class="bi bi-bar-chart-line-fill"></i> Biggest Challenges & Learnings</h3><div class="text-gray-700 mt-1 prose prose-sm">${t(e.m3s7_challenges)}</div></div><div><h3 class="font-bold text-lg flex items-center gap-2" style="color: var(--review-blue-text);"><i class="bi bi-bullseye"></i> Performance vs Narrative</h3><div class="text-gray-700 mt-1 prose prose-sm">${t(e.m3s7_narrative)}</div></div><div><h3 class="font-bold text-lg flex items-center gap-2" style="color: var(--review-blue-text);"><i class="bi bi-forward-fill"></i> Focus For Next Quarter</h3><div class="text-gray-700 mt-1 prose prose-sm">${t(e.m3s7_next_quarter)}</div></div></div></div>
    </div>`}function Oe(e){k.mainContent.scrollTop=0,g.currentView=e,sessionStorage.setItem("lastPlanId",g.currentPlanId),sessionStorage.setItem("lastViewId",e);const t={vision:{title:`Bakery Growth Plan - ${g.planData.quarter||""}`,subtitle:g.planData.planName||"Your 90-Day Sprint to a Better Bakery."},"month-1":{title:"Month 1 Plan",subtitle:g.planData.planName||"Lay the foundations for success."},"month-2":{title:"Month 2 Plan",subtitle:g.planData.planName||"Build momentum and embed processes."},"month-3":{title:"Month 3 Plan",subtitle:g.planData.planName||"Refine execution and review the quarter."},summary:{title:`Plan Summary - ${g.planData.quarter||""}`,subtitle:g.planData.planName||"A complete overview of your quarterly plan."},files:{title:"My Files",subtitle:`Manage documents for ${g.planData.planName||"your plan"}.`}};k.headerTitle.textContent=t[e]?.title||"Growth Plan",k.headerSubtitle.textContent=t[e]?.subtitle||"";const n=e==="summary";if(k.desktopHeaderButtons.classList.toggle("hidden",!n),n)Re();else if(e==="files")k.contentArea.innerHTML=me.files.html,Et();else{const s=e.startsWith("month-")?e.split("-")[1]:null;k.contentArea.innerHTML=s?me.month(s):me.vision.html,Lt(),Bt(),s&&Ve(s,g.planData)}document.querySelectorAll("#main-nav a").forEach(s=>s.classList.remove("active")),document.querySelector(`#nav-${e}`)?.classList.add("active"),ve&&ve()}function Tt(e){g.currentPlanId=e,k.appView.classList.remove("hidden"),g.planUnsubscribe&&g.planUnsubscribe();const t=W.collection("users").doc(g.currentUser.uid).collection("plans").doc(e);g.planUnsubscribe=t.onSnapshot(n=>{if(n.exists){const s=n.data();JSON.stringify(s)!==JSON.stringify(g.planData)&&(g.planData=s,It(s),Se())}else console.error("Plan document not found! Returning to dashboard."),document.dispatchEvent(new CustomEvent("back-to-dashboard"))},n=>{console.error("Error listening to plan changes:",n),document.dispatchEvent(new CustomEvent("back-to-dashboard"))}),t.get().then(n=>{if(n.exists){g.planData=n.data(),Se();const s=sessionStorage.getItem("lastViewId")||"vision";Oe(s)}})}function At(e,t,n,s,a,i){if(W=e,g=t,ve=s,ce=a,Ae=i,t.forceSave=()=>ne(!0),!k.mainNav)return;k.mainNav.addEventListener("click",l=>{l.preventDefault();const m=l.target.closest("a");m&&Oe(m.id.replace("nav-",""))}),k.contentArea.addEventListener("input",l=>{const m=l.target;if(m.matches('input, [contenteditable="true"]')){const p=m.id,u=m.isContentEditable?m.innerHTML:m.value;g.planData[p]!==u&&(g.planData[p]=u,ne())}m.isContentEditable&&(m.innerText.trim()===""?m.classList.add("is-placeholder-showing"):m.classList.remove("is-placeholder-showing"))}),k.contentArea.addEventListener("keydown",l=>{const m=l.target.closest('[contenteditable="true"]');if(!m)return;(l.ctrlKey||l.metaKey)&&l.key.toLowerCase()==="b"&&(l.preventDefault(),document.execCommand("bold",!1,null));const p=parseInt(m.dataset.maxlength,10);if(p){const u=l.key.length>1||l.ctrlKey||l.metaKey;m.innerText.length>=p&&!u&&l.preventDefault()}}),k.contentArea.addEventListener("click",l=>{const m=l.target.closest(".pillar-button");if(m){m.classList.toggle("selected");const b=m.closest(".pillar-buttons"),h=`${b.dataset.stepKey}_pillar`,y=Array.from(b.querySelectorAll(".selected")).map(x=>x.dataset.pillar),E={};E[h]=y.length>0?y:firebase.firestore.FieldValue.delete(),g.planData[h]=y.length>0?y:void 0,y.length===0&&delete g.planData[h],W.collection("users").doc(g.currentUser.uid).collection("plans").doc(g.currentPlanId).update({...E,lastEdited:firebase.firestore.FieldValue.serverTimestamp()}).catch(x=>console.error("Error updating pillar:",x));return}const p=l.target.closest(".status-button");if(p){const b=p.classList.contains("selected"),f=p.parentElement;f.querySelectorAll(".status-button").forEach(w=>w.classList.remove("selected"));const h=g.currentView.split("-")[1],y=f.dataset.week,E=`m${h}s5_w${y}_status`,B={};if(b)B[E]=firebase.firestore.FieldValue.delete(),delete g.planData[E];else{p.classList.add("selected");const w=p.dataset.status;B[E]=w,g.planData[E]=w}W.collection("users").doc(g.currentUser.uid).collection("plans").doc(g.currentPlanId).update({...B,lastEdited:firebase.firestore.FieldValue.serverTimestamp()}).catch(w=>console.error("Error updating status:",w))}const u=l.target.closest(".weekly-tab");if(u){l.preventDefault();const b=u.dataset.week;document.querySelectorAll(".weekly-tab").forEach(f=>f.classList.remove("active")),u.classList.add("active"),document.querySelectorAll(".weekly-tab-panel").forEach(f=>{f.classList.toggle("hidden",f.dataset.weekPanel!==b)}),document.querySelectorAll('[id^="weekly-progress-label-"]').forEach(f=>{const h=f.id.split("-").pop();f.textContent=`Week ${h} Progress:`})}}),k.backToDashboardBtn.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("back-to-dashboard"))}),k.sidebarLogoutBtn.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("logout-request"))}),k.printBtn.addEventListener("click",()=>window.print()),k.shareBtn.addEventListener("click",()=>Ae(W,g)),k.aiActionBtn.addEventListener("click",()=>{const l=he(g.planData);ce(g,ne,l)});const r=document.getElementById("radial-action-plan");r&&r.addEventListener("click",()=>{const l=he(g.planData);ce(g,ne,l),document.getElementById("radial-menu-container").classList.remove("open")});const c=document.getElementById("sidebar-logo-link");c&&c.addEventListener("click",l=>{l.preventDefault(),document.dispatchEvent(new CustomEvent("back-to-dashboard"))});const d=document.getElementById("radial-action-gemini");d&&d.addEventListener("click",()=>{bt(),document.getElementById("radial-menu-container").classList.remove("open")})}async function St(){try{const e=await Ye(),t=firebase.initializeApp(e);Pt(t)}catch(e){console.error("Failed to initialize Firebase:",e),document.body.innerHTML='<div style="text-align: center; padding: 40px; font-family: sans-serif;"><h1>Error</h1><p>Could not load application configuration. Please contact support.</p></div>'}}function Pt(e){const t=firebase.auth(),n=firebase.firestore(),s=firebase.storage(),a={planData:{},currentUser:null,currentPlanId:null,currentView:"vision",planUnsubscribe:null,calendarUnsubscribe:null,calendar:{currentDate:new Date,data:{},editingEventIndex:null},aiPlanGenerationController:null};je(t),pt(n,a),tt(n,a,P),it(n,a,P,i),At(n,a,P,ut,ye,mt),vt(a,n),xt(n,s,a);function i(c){document.getElementById("dashboard-view").classList.add("hidden"),document.getElementById("radial-menu-container").classList.remove("hidden"),Tt(c)}function r(){a.planUnsubscribe&&a.planUnsubscribe(),a.calendarUnsubscribe&&a.calendarUnsubscribe(),sessionStorage.removeItem("lastPlanId"),sessionStorage.removeItem("lastViewId"),document.getElementById("app-view").classList.add("hidden"),document.getElementById("radial-menu-container").classList.add("hidden"),document.getElementById("dashboard-view").classList.remove("hidden"),oe()}document.addEventListener("logout-request",c=>{if(c.detail&&c.detail.isTimeout&&P("timeout"),c.detail&&c.detail.isRevival){const d=document.getElementById("auth-error");d&&(d.textContent="For your security, please sign in again.",d.style.display="block")}Ge()}),document.addEventListener("back-to-dashboard",r),document.addEventListener("rerender-dashboard",oe),document.addEventListener("plan-selected",c=>i(c.detail.planId)),t.onAuthStateChanged(async c=>{const d=document.getElementById("initial-loading-view"),l=document.getElementById("login-view"),m=document.getElementById("dashboard-view"),p=document.getElementById("app-view");if(a.planUnsubscribe&&a.planUnsubscribe(),a.calendarUnsubscribe&&a.calendarUnsubscribe(),c){const u=localStorage.getItem("lastActivity"),b=480*60*1e3;if(u&&new Date().getTime()-u>b){console.log("Maximum inactivity period exceeded. Forcing logout."),document.dispatchEvent(new CustomEvent("logout-request",{detail:{isRevival:!0}}));return}if(localStorage.setItem("lastActivity",new Date().getTime()),d&&d.classList.remove("hidden"),l&&l.classList.add("hidden"),a.currentUser=c,!(await n.collection("users").doc(c.uid).get()).exists){d&&d.classList.add("hidden"),window.location.href="/profile.html?setup=true";return}We(a);const y=sessionStorage.getItem("lastPlanId");y?i(y):(m&&m.classList.remove("hidden"),p&&p.classList.add("hidden"),await oe())}else{if(a.currentUser=null,a.currentPlanId=null,a.planData={},Ke(),window.location.pathname!=="/index.html"&&window.location.pathname!=="/"&&window.location.pathname!=="/action.html"){window.location.href="/index.html";return}m&&m.classList.add("hidden"),p&&p.classList.add("hidden");const u=document.getElementById("modal-overlay");u&&u.classList.add("hidden");const b=document.getElementById("calendar-modal");b&&b.classList.add("hidden");const f=document.getElementById("radial-menu-container");f&&f.classList.add("hidden"),l&&l.classList.remove("hidden")}d&&d.classList.add("hidden")})}document.addEventListener("DOMContentLoaded",St);export{Ge as h};
